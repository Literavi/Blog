<script>
  const spreadsheetId = "11Rowjfar9c6yeLdr1Qirt4RWfDMUHg1ZX3MB4FHzHyc"; // Seu Spreadsheet ID
  const apiKey = "AIzaSyBFBF48H0WgkPAh5QRyPSctsrH8GAM7OTs"; // Sua chave de API
  const sheetName = "Biblioteca_Pessoal"; // Nome da aba na planilha

  const googleSheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;

  let mesSelecionado = null; // Variável para armazenar o índice do mês selecionado

  function carregarDadosEExibirGrafico() {
    fetch(googleSheetsApiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error("Erro ao carregar dados da API do Google Sheets");
        }
        return response.json();
      })
      .then(data => {
        const rows = data.values;
        const meses = [
          'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const livrosFisicosPorMes = Array(12).fill(0); // Contadores para livros Físicos
        const livrosEbooksPorMes = Array(12).fill(0); // Contadores para eBooks
        const capasFisico = Array(12).fill().map(() => []); // Capas para livros Físicos
        const capasEbook = Array(12).fill().map(() => []); // Capas para eBooks

        // Identifica o índice das colunas
        const headerRow = rows[0];
        const dateLidoIndex = headerRow.indexOf("Date Lido");
        const formatoIndex = headerRow.indexOf("Formato");
        const imageFileIndex = headerRow.indexOf("ImageFile");

        // Processa os dados da planilha
        rows.slice(1).forEach(row => {
          const date = row[dateLidoIndex];
          const formato = row[formatoIndex];
          const imageFile = row[imageFileIndex];
          if (date) {
            const [day, month, year] = date.split("/").map(Number);

            if (year === 2024 && month >= 1 && month <= 12) {
              if (formato === "Físico") {
                livrosFisicosPorMes[month - 1]++;
                if (imageFile) {
                  const imageUrl = `https://raw.githubusercontent.com/Literavi/Blog/main/imagens/${imageFile}`;
                  capasFisico[month - 1].push(imageUrl);
                }
              } else if (formato === "eBook") {
                livrosEbooksPorMes[month - 1]++;
                if (imageFile) {
                  const imageUrl = `https://raw.githubusercontent.com/Literavi/Blog/main/imagens/${imageFile}`;
                  capasEbook[month - 1].push(imageUrl);
                }
              }
            }
          }
        });

        // Inicializa o gráfico com os dados carregados
        const ctx = document.getElementById('livrosLidosChart').getContext('2d');
        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: meses,
            datasets: [
              {
                label: 'Físico',
                data: livrosFisicosPorMes,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              },
              {
                label: 'eBook',
                data: livrosEbooksPorMes,
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Quantidade de Livros'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Mês'
                }
              }
            },
            onClick: (event, elements) => {
              const capaLivroContainer = document.getElementById("capaLivroContainer");
              if (elements.length) {
                const elementIndex = elements[0].index; // Índice do mês

                // Alterna a exibição das capas
                if (mesSelecionado === elementIndex) {
                  capaLivroContainer.style.display = "none";
                  mesSelecionado = null; // Deseleciona o mês
                } else {
                  mesSelecionado = elementIndex; // Atualiza para o mês selecionado
                  capaLivroContainer.innerHTML = ''; // Limpa o conteúdo anterior
                  
                  // Combina todas as capas (Físico e eBook) para o mês
                  const capasDoMes = [...capasFisico[elementIndex], ...capasEbook[elementIndex]];

                  if (capasDoMes.length > 0) {
                    capasDoMes.forEach(url => {
                      const img = document.createElement('img');
                      img.src = url;
                      img.alt = 'Capa do Livro';
                      capaLivroContainer.appendChild(img);
                    });
                    capaLivroContainer.style.display = "flex";
                  } else {
                    capaLivroContainer.style.display = "none";
                  }
                }
              }
            }
          }
        });

      })
      .catch(error => {
        console.error("Erro ao carregar dados da API do Google Sheets:", error);
      });
  }

  // Carrega os dados e exibe o gráfico ao carregar a página
  carregarDadosEExibirGrafico();
</script>
